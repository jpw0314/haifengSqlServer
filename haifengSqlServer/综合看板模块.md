# 综合看板模块

### 1、订单情况

```sql
sql语句

SELECT Convert(decimal(18,0), oknumb)oknumb ,
       Convert(decimal(18, 0), total)total,
       Convert(decimal(18, 2), oknumb*100/total) AS ratess,right( dayss,5)dayss
FROM 
    (SELECT top 6 sum(F_OkQty) oknumb,
        sum(F_OkQty+F_NgQty)total,
        CONVERT(varchar(100), F_CreatorTime, 111)   dayss
    FROM mes_report_detail
    WHERE datediff(day,F_CreatorTime,getdate())<=14  and datediff(day,F_CreatorTime,getdate())>= 0 and (F_OkQty+F_NgQty)>0  
    GROUP BY  CONVERT(varchar(100), F_CreatorTime, 111)  
    ORDER BY  dayss desc) a
ORDER BY  dayss

响应数据格式(只展示至多三条数据，多的不显示)

[
    {
        "oknumb": 24400,
        "total": 24760,
        "ratess": 98.55,
        "dayss": "12/02"
    },
    {
        "oknumb": 22670,
        "total": 22930,
        "ratess": 98.87,
        "dayss": "12/03"
    }
]
```

### 2、设备情况

```sql
sql语句

select onoffrate,oee,right(dayss,5)dayss1 from (
select top 6 F_EqOnOffRate onoffrate, F_Efficienc oee,  CONVERT(NVARCHAR(50),F_EqRunDate,111)  dayss  
from base_equip_runinfo
 where  datediff(day,F_EqRunDate,getdate())<=30  and  datediff(day,F_EqRunDate,getdate())>0
order by dayss desc
)aa 
order by dayss

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "onoffrate": 86.9,
        "oee": 80.4,
        "dayss1": "12/03"
    },
    {
        "onoffrate": 87.4,
        "oee": 80.8,
        "dayss1": "12/04"
    }
]

```

### 3、注塑日产量

```sql
sql语句

	select  right(dayss,5) dayss,numb from (
	select top 6 convert(nvarchar(10), F_RecordDate,120) dayss,sum(F_HadDone) numb  from eq_yield_day
	WHERE datediff(day,F_RecordDate,getdate())<=14  and datediff(day,F_RecordDate,getdate())>= 0 and F_HadDone>0 
	and F_EquipName like '%注塑%'
	group by convert(nvarchar(10), F_RecordDate,120)
	order by convert(nvarchar(10), F_RecordDate,120) desc
	)aa
	order by dayss
	
响应数据格式(只展示至多三条数据，多的不显示)

[
    {
        "dayss": "12-04",
        "numb": 54332
    },
    {
        "dayss": "12-05",
        "numb": 41236
    }
]
```

### 4、当月注塑机产量

```sql
sql语句

select * from (
select top 5 right(F_EquipCode,2)+'#'equip,sum(F_HadDone) haddone from eq_yield_day
where F_EquipName like '%注塑%' and convert(nvarchar(7),F_RecordDate,120) =convert(nvarchar(7),GETDATE(),120) 
group by F_EquipCode,	F_EquipId
order by sum(F_HadDone) desc
)a 
order by equip

响应数据格式(只展示至多三条数据，多的不显示)

[
    {
        "equip": "19#",
        "haddone": 26633
    },
    {
        "equip": "23#",
        "haddone": 17942
    }
]
```

### 5、设备故障明细

```sql
sql语句

SELECT TOP 3 F_TagDesc AS ErrorMsg,F_UploadTime AS UpTime FROM eq_tagsetting WHERE F_TagDesc LIKE '系统%' AND F_Result='1' ORDER BY F_UploadTime DESC

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "ErrorMsg": "系统一17号站缺料",
        "UpTime": "2025-01-15 09:04:25"
    },
    {
        "ErrorMsg": "系统二12号站缺料",
        "UpTime": "2025-01-14 10:56:00"
    }
]
```

### 6、产品入库分析

```sql
sql语句

SELECT OpDate name,FinishInQty value FROM #InWarehouseInfo order by OpDate
DROP TABLE #InWarehouseInfo

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "name": "12/03",
        "value": 218800
    },
    {
        "name": "12/04",
        "value": 186400
    }
]


```

### 7、设备运行情况

```sql
sql语句

DECLARE @RunNum			INT
DECLARE @OpenNum		INT
DECLARE @WarnNum		INT
DECLARE @CloseNum		INT
DECLARE @TotalNum		INT
SELECT @RunNum=COUNT(F_Id) from base_equip where F_Status='1'  AND F_WorkshopId='1081' AND F_IsVirtual!=2 --运行
SELECT @OpenNum=COUNT(F_Id) from base_equip where F_Status='0'  AND F_WorkshopId='1081' AND F_IsVirtual!=2 --待机
SELECT @WarnNum=COUNT(F_Id) from base_equip where F_Status='-1'  AND F_WorkshopId='1081' AND F_IsVirtual!=2 --报警
SELECT @CloseNum=COUNT(F_Id) from base_equip where F_Status='9'  AND F_WorkshopId='1081' AND F_IsVirtual!=2 --关机
SELECT @TotalNum=COUNT(F_Id) from base_equip where  F_WorkshopId='1081' AND F_IsVirtual!=2 --总数
SELECT @RunNum AS RunNum,@OpenNum AS OpenNum,@WarnNum AS WarnNum,@CloseNum AS CloseNum,@TotalNum AS TotalNum

优化的sql语句
-- 稍微简单一点的写法
SELECT 
    SUM(CASE F_Status WHEN '1' THEN 1 ELSE 0 END) AS RunNum,
    SUM(CASE F_Status WHEN '0' THEN 1 ELSE 0 END) AS OpenNum,
    SUM(CASE F_Status WHEN '-1' THEN 1 ELSE 0 END) AS WarnNum,
    SUM(CASE F_Status WHEN '9' THEN 1 ELSE 0 END) AS CloseNum,
    COUNT(*) AS TotalNum
FROM base_equip 
WHERE F_WorkshopId='1081' AND F_IsVirtual!=2


响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "RunNum": 37,
        "OpenNum": 7,
        "WarnNum": 0,
        "CloseNum": 5,
        "TotalNum": 52
    }
]
```

### 8、设备信息表

```sql
sql语句

SELECT *,
	(SELECT F_EquipCode FROM base_equip WHERE F_Id=F_EquipId) AS EquipCode
FROM
(SELECT 
REPLACE(F_TagId, F_EquipId + '/','') AS ParamName,
F_Result AS CurValue,
F_EquipId
FROM eq_tagsetting
WHERE F_EquipId=(SELECT TOP 1 F_Id FROM base_equip WHERE
F_EquipCode LIKE 'A.01%' AND F_WorkshopId='1081' AND F_IsVirtual!=2 ORDER BY NEWID()))
AS SourceTable
PIVOT
(
	MAX(CurValue)
	FOR ParamName IN (Currentyield,lastCyclePeriod,recentUseRate)
) AS PivotTable

响应数据格式(只展示至多三条数据，多的不显示)


[
    {
        "F_EquipId": "18272000",
        "Currentyield": "1016676",
        "lastCyclePeriod": "46.0",
        "recentUseRate": "100",
        "EquipCode": "A.01.200G.24"
    }
]
```

### 9、计划生产工单

```sql
sql语句

SELECT TOP 3 ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) AS RowNum, F_WoNo AS WoNo,'生产中' AS StrStatus FROM base_workorder WHERE F_Status=3 ORDER BY F_IssueTime DESC

响应数据格式(只展示至多三条数据，多的不显示)

[
    {
        "RowNum": 1,
        "WoNo": "WO20241129004",
        "StrStatus": "生产中"
    },
    {
        "RowNum": 2,
        "WoNo": "WO20241128003",
        "StrStatus": "生产中"
    },
    {
        "RowNum": 3,
        "WoNo": "WO20241126003",
        "StrStatus": "生产中"
    }
]
```

### 10、热销机型排行

```sql
sql语句

SELECT TOP 4 a.F_PartNo AS PartNo,SUM(a.F_PlanQty) AS TotalQty FROM wms_warehouseout_detail a LEFT JOIN wms_warehouseout b ON a.F_WarehouseOutId=b.F_Id
 WHERE b.F_WarehouseType='SaleOut' GROUP BY F_PartNo ORDER BY TotalQty DESC
 
响应数据格式(只展示至多三条数据，多的不显示)
 [
    {
        "PartNo": "02.01.C.Z-0321-05",
        "TotalQty": 600000
    },
    {
        "PartNo": "01.WM.PM32.D019-P",
        "TotalQty": 584932
    }
]
```

### 11、设备效率

#### 11.1设备故障率

```sql
sql语句

DECLARE @WarnNum		INT
DECLARE @TotalNum		INT
DECLARE @WarnRate		DECIMAL(18,0)
SELECT @WarnNum=COUNT(F_Id) from base_equip where F_Status='-1'  AND F_WorkshopId='1081' AND F_IsVirtual!=2 --报警
SELECT @TotalNum=COUNT(F_Id) from base_equip where  F_WorkshopId='1081' AND F_IsVirtual!=2 --总数
SET @WarnRate=@WarnNum*100.00/IIF(@TotalNum=0, 1, @TotalNum)
SELECT CONVERT(VARCHAR, @WarnRate) +'%' AS WarnRate

优化的sql语句
SELECT 
    CONVERT(VARCHAR, 
        SUM(CASE F_Status WHEN '-1' THEN 1 ELSE 0 END) * 100.00 / 
        NULLIF(COUNT(*), 0)
    ) + '%' AS WarnRate
FROM base_equip 
WHERE F_WorkshopId='1081' AND F_IsVirtual!=2

响应数据格式(只展示至多三条数据，多的不显示)

{
    "value": "0%"
}
```

#### 11.2设备开机率

```sql
sql语句

DECLARE @OpenNum		INT
DECLARE @TotalNum		INT
DECLARE @OpenRate		DECIMAL(18,0)
SELECT @OpenNum=COUNT(F_Id) from base_equip where (F_Status='0' OR F_Status='1') AND F_WorkshopId='1081' AND F_IsVirtual!=2 --待机+运行
SELECT @TotalNum=COUNT(F_Id) from base_equip where  F_WorkshopId='1081' AND F_IsVirtual!=2 --总数
SET @OpenRate=@OpenNum*100.00/IIF(@TotalNum=0, 1, @TotalNum)
SELECT CONVERT(VARCHAR, @OpenRate) +'%' AS OpenRate

优化后的sql语句
SELECT 
    CONVERT(VARCHAR, 
        SUM(CASE WHEN F_Status IN ('0', '1') THEN 1 ELSE 0 END) * 100.00 / 
        NULLIF(COUNT(*), 0)
    ) + '%' AS OpenRate
FROM base_equip 
WHERE F_WorkshopId='1081' AND F_IsVirtual!=2

响应数据格式(只展示至多三条数据，多的不显示)

{
    "value": "85%"
}
```
