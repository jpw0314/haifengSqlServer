# 质量看板模块

### 1、品质分析（日）

```sql
sql语句

WITH TotalQty AS (
    SELECT 
        SUM(F_Qty) AS total_qty
    FROM 
        qc_record_result  -- 直接从 qc_record_result 表计算总数量
)
SELECT 
    b.F_Content dayss,
    SUM(c.F_Qty) AS total,
    (SUM(c.F_Qty) * 100.0 / t.total_qty) AS ratess
FROM 
    qc_record_detail a
LEFT JOIN 
    qc_record_result c ON a.F_ResultId = c.F_Id
LEFT JOIN 
    base_quailty b ON a.F_QuailtyId = b.F_Id
CROSS JOIN 
    TotalQty t
GROUP BY 
    b.F_Content, t.total_qty
ORDER BY 
    dayss DESC;
    
    响应数据格式(只展示至多三条数据，多的不显示)
    
[
    {
        "dayss": "装配",
        "total": 958,
        "ratess": 0.004013
    },
    {
        "dayss": "一致性",
        "total": 473,
        "ratess": 0.001981
    },
    {
        "dayss": "外观",
        "total": 6858,
        "ratess": 0.028733
    },
    {
        "dayss": "测试不良项",
        "total": 128,
        "ratess": 0.000536
    }
]
```

### 2、工序合格率

```sql
sql语句
select F_NodeName,sum(F_OkQty)*100.0/IIF(ISNULL(sum(F_OkQty+F_NgQty),0)=0,1,sum(F_OkQty+F_NgQty)) rate
from mes_report_detail
where F_NodeName is not null
group by F_NodeName
响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "F_NodeName": "手工组装-旋转拖把大杆",
        "rate": 99.819331
    },
    {
        "F_NodeName": "刮刮乐面板",
        "rate": 100
    },
    {
        "F_NodeName": "马桶刷下手柄壳",
        "rate": 100
    }
]
```

### 3、月生产效率分析

#### 3.1 检验总数

```sql
sql语句

select  sum(F_RequireAmount) total
--case when sum(F_RealAmount)>0 then  sum(F_OkQty)*100 /sum(F_RealAmount) else 100 end  as okRate,
--case when sum(F_RequireAmount)>0 then  sum(F_RealAmount)*100 /sum(F_RequireAmount) else 100 end planRate
  from base_workorder a
where  datediff(month, F_CreatorTime,getdate()) = 0

响应数据格式(只展示至多三条数据，多的不显示)

{
    "value": "47452956"
}


```

#### 3.2 合格率

```sql
sql语句

select 
case when sum(F_RealAmount)>0 then  sum(F_OkQty)*100 /sum(F_RealAmount) else 100 end  as okRate
--case when sum(F_RequireAmount)>0 then  sum(F_RealAmount)*100 /sum(F_RequireAmount) else 100 end planRate
  from base_workorder a
where  datediff(month, F_CreatorTime,getdate()) = 0


//注意WHERE是限制当天数据，所以当天数据可能为空。如需查看数据格式请去掉后执行语句
响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "100.00"
}
```

#### 3.3 达成率

```sql
sql语句

select 
case when sum(F_RequireAmount)>0 then  sum(F_RealAmount)*100 /sum(F_RequireAmount) else 100 end planRate
  from base_workorder a
where  datediff(month, F_CreatorTime,getdate()) = 0

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "100.00"
}

```

### 4、日合格率趋势分析

```sql

sql语句

select top 7 convert(nvarchar(10),a.F_CreatorTime,120) a1,sum(F_Ok)*100.0/IIF(ISNULL(sum(F_Qty),0)=0,1,sum(F_qty)) rate from qc_record a
group by convert(nvarchar(10),a.F_CreatorTime,120)
order by convert(nvarchar(10),a.F_CreatorTime,120)

响应数据格式(只展示至多三条数据，多的不显示)

[
    {
        "a1": "2023-04-10",
        "rate": 99.923669
    },
    {
        "a1": "2023-04-11",
        "rate": 98.529946
    },
    {
        "a1": "2023-04-17",
        "rate": 90
    }
]
```

### 5、检验效率分析

#### 5.1 检验总完成率

```sql
sql语句
select sum(case when F_Status=2 then 1 else 0 end)*100.0/IIF(ISNULL(count(1),0)=0,1,count(1))  value
from qc_record

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "93.85"
}
```

#### 5.2 来料检验完成率

```sql
sql语句

select ISNULL(sum(case when F_Status=2 then 1 else 0 end)*100.0/IIF(ISNULL(count(1),0)=0,1,count(1)),0)  value
from qc_record where 
F_BillType='IQC'

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "0.00"
}
```

#### 5.3 生产检验完成率

```sql
sql语句

select ISNULL(sum(case when F_Status=2 then 1 else 0 end)*100.0/IIF(ISNULL(count(1),0)=0,1,count(1)),0)  value
from qc_record where 
F_BillType='FQC'

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "91.05"
}
```

#### 5.4 首检验完成率

```sql
sql语句

select ISNULL(sum(case when F_Status=2 then 1 else 0 end)*100.0/IIF(ISNULL(count(1),0)=0,1,count(1)),0)  value
from qc_record where 
F_BillType='IpqcFirst'

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "100.00"
}
```

#### 5.5 巡检完成率

```sql
sql语句

select ISNULL(sum(case when F_Status=2 then 1 else 0 end)*100.0/IIF(ISNULL(count(1),0)=0,1,count(1)),0)  value
from qc_record where 
F_BillType='IpqcInspection'

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "92.71"
}
```

### 6、检验单状态

```sql
sql语句

SELECT count(*) as value,'待检验' name from qc_record where   F_Status=0
	union all
SELECT count(*) as value,'检验中' name  from qc_record where   F_Status=1
union all
SELECT count(*) as value,'已完成' name  from qc_record where  F_Status=2

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "value": 383,
        "name": "待检验"
    },
    {
        "value": 0,
        "name": "检验中"
    },
    {
        "value": 5842,
        "name": "已完成"
    }
]
```

### 7、检验进度

```sql
sql语句
select top 50
F_WoNo 工单号
,F_PartNo 物料编号
,F_PartName 物料名称
,F_PartSpecs 规格
,F_Qty 检验数量
,F_ok 合格数
,F_Ng 不良数
from qc_record where F_Status<2
order by F_BillDate 

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "工单号": "WO20250930034",
        "物料编号": "02.03.B.PM32.1101-10",
        "物料名称": "四面挤水拖把-面板销子-小米白7043",
        "规格": "4.5*0.5",
        "检验数量": 11120,
        "合格数": 11000,
        "不良数": 120
    },
    {
        "工单号": "WO20250930034",
        "物料编号": "02.03.B.PM32.1101-10",
        "物料名称": "四面挤水拖把-面板销子-小米白7043",
        "规格": "4.5*0.5",
        "检验数量": 20,
        "合格数": 0,
        "不良数": 0
    },
    {
        "工单号": "WO20250930034",
        "物料编号": "02.03.B.PM32.1101-10",
        "物料名称": "四面挤水拖把-面板销子-小米白7043",
        "规格": "4.5*0.5",
        "检验数量": 30,
        "合格数": 0,
        "不良数": 0
    }
]

```

### 8、来料不良分析

```sql
sql语句
WITH TotalQty AS (
    SELECT 
        SUM(F_Qty) AS total_qty
    FROM 
        qc_record_result  -- 直接从 qc_record_result 表计算总数量
)
SELECT 
    b.F_Content name,
    SUM(c.F_Qty) AS value
FROM 
    qc_record_detail a
LEFT JOIN 
    qc_record_result c ON a.F_ResultId = c.F_Id
	left join qc_record cc on c.F_BillId=c.F_Id
LEFT JOIN 
    base_quailty b ON a.F_QuailtyId = b.F_Id
CROSS JOIN 
    TotalQty t
--where cc.F_BillType='IQC'
GROUP BY 
    b.F_Content, t.total_qty
ORDER BY 
    name DESC;

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "name": "装配",
        "value": 958
    },
    {
        "name": "一致性",
        "value": 473
    },
    {
        "name": "外观",
        "value": 6858
    },
    {
        "name": "测试不良项",
        "value": 128
    }
]
```

### 9、车间合格率分析

```sql
sql语句

select aa.name,convert( decimal(18,2), round(sum(value),2)) value from (
select case when  a.F_id='1081' then '注塑'
when a.F_id='1082' then '杆盘'
else '包装' end name
,ISNULL(sum(b.F_OkQty)*100.0/IIF(ISNULL(sum(b.F_OkQty+b.F_ngqty),0)=0,1,sum(b.F_OkQty+b.F_ngqty)),0) value
 from base_organize a 
 left join base_workorder c on a.F_id=c.F_WorkShopId
left join mes_report_detail b on b.F_WoId=c.F_Id
where F_EnCode in ('H.001','H.002','H.003')
group by a.F_Id
)aa group by aa.name

响应数据格式(只展示至多三条数据，多的不显示)
{
    "xList": [
        99.71,
        100,
        99.99
    ],
    "yList": [
        "包装",
        "杆盘",
        "注塑"
    ]
}

```

### 10、返工信息统计

```sql
sql语句

select  right(convert(nvarchar(10),a.F_CreatorTime,120),5) dayss,sum(a.F_Qty) oknumb 
,convert(decimal(18,2),round(sum(a.F_Qty)*100.0/IIF(ISNULL(sum(b.F_Qty),0)=0,1,sum(b.F_Qty)),2)) ratess from qc_record_result  a
left join qc_record b on a.F_BillId=b.F_Id
where a.F_Decision=4 --返工
group by convert(nvarchar(10),a.F_CreatorTime,120)
order by convert(nvarchar(10),a.F_CreatorTime,120)

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "dayss": "12-09",
        "oknumb": 1,
        "ratess": 1
    },
    {
        "dayss": "12-23",
        "oknumb": 20,
        "ratess": 5
    }
]
```
