[# name=生产统计分析图表]
[production.stats_by_day]
wrap=none
columns=OkQty:decimal(18,0),TotalQty:decimal(18,0),OkRate:decimal(18,2),OpDate:varchar(5)
sql=SELECT CONVERT(DECIMAL(18,0), OkQty) OkQty, CONVERT(DECIMAL(18, 0), TotalQty) TotalQty, CONVERT(DECIMAL(18, 2), OkQty*100/IIF(TotalQty=0, 1, TotalQty)) AS OkRate, RIGHT(OpDate,5) OpDate FROM (SELECT TOP 3 SUM(F_OkQty) OkQty, SUM(F_OkQty+F_NgQty) TotalQty, CONVERT(VARCHAR(100), F_CreatorTime, 111) OpDate FROM mes_report_detail WHERE DATEDIFF(DAY,F_CreatorTime,GETDATE())<=14 AND DATEDIFF(day,F_CreatorTime,GETDATE())>=0 AND (F_OkQty+F_NgQty)>0 GROUP BY CONVERT(VARCHAR(100), F_CreatorTime, 111) ORDER BY OpDate DESC) a ORDER BY OpDate

[# name=原料消耗统计图表]
[production.raw_material_consumption]
wrap=none
columns=oknumb:decimal(18,0),total:decimal(18,0),ratess:decimal(18,2),dayss:varchar(5)
sql=SELECT Convert(decimal(18,0), oknumb) oknumb, Convert(decimal(18, 0), total) total, Convert(decimal(18, 2), oknumb*100/total) AS ratess, RIGHT(dayss,5) dayss FROM (SELECT TOP 6 SUM(F_OkQty) oknumb, SUM(F_OkQty+F_NgQty) total, CONVERT(varchar(100), F_CreatorTime, 111) dayss FROM mes_report_detail WHERE DATEDIFF(day,F_CreatorTime,GETDATE())<=14 AND DATEDIFF(day,F_CreatorTime,GETDATE())>=0 AND (F_OkQty+F_NgQty)>0 GROUP BY CONVERT(varchar(100), F_CreatorTime, 111) ORDER BY dayss DESC) a ORDER BY dayss

[# name=月合格率]
[production.month_ok_rate]
returns=scalar
wrap=none
columns=value:decimal(18,0)
sql=SELECT CONVERT(DECIMAL(18,0), ROUND(SUM(F_OkQty)*100.00 / IIF(SUM(F_OkQty+F_NgQty)=0, 1, SUM(F_OkQty+F_NgQty)), 0)) value FROM mes_report_detail WHERE DATEDIFF(mm, F_CreatorTime, GETDATE())=0

[# name=日合格率]
[production.day_ok_rate]
wrap=none
columns=value:decimal(18,0)
sql=SELECT CONVERT(DECIMAL(18,0), ROUND(ISNULL(SUM(F_OkQty),0)*100.00 / IIF(ISNULL(SUM(F_OkQty+F_NgQty),0)=0, 1, SUM(F_OkQty+F_NgQty)), 2)) value FROM mes_report_detail WHERE DATEDIFF(dd, F_CreatorTime, GETDATE())=0

[# name=完成计划]
[production.plan_completion]
returns=scalar
wrap=none
columns=value:varchar(20)
sql=SELECT CONVERT(NVARCHAR(10), CONVERT(DECIMAL(18,0), ISNULL(SUM(F_OkQty+F_NgQty),0))) + '/' + CONVERT(NVARCHAR(20), CONVERT(DECIMAL(18,0), ISNULL(SUM(F_RequireAmount),0))) value FROM base_workorder WHERE DATEDIFF(dd, F_CreatorTime, GETDATE())=0

[# name=实时产能监控]
[production.capacity_monitor]
wrap=none
columns=value:varchar(100),name:int
sql=SELECT aa.F_FullName value, ISNULL(bb.数量,0) name FROM base_organize aa LEFT JOIN (SELECT b.F_WorkShopId, SUM(a.F_OkQty+a.F_NgQty) 数量 FROM mes_report_detail a LEFT JOIN base_workorder b ON F_WoId=b.F_Id WHERE DATEDIFF(mm, a.F_creatortime, GETDATE())=0 GROUP BY b.F_WorkShopId) bb ON aa.F_Id=bb.F_WorkShopId WHERE aa.F_Id IN ('1081','1082','1083')

[# name=生产进度信息]
[production.progress_info]
wrap=none
columns=工单号:varchar(50),物料编号:varchar(50),物料名称:varchar(100),规格型号:varchar(50),合格数:decimal(18,0),不良数:decimal(18,0),需求数:decimal(18,0),单位:varchar(10),生产进度:varchar(10),生产状态:varchar(10)
sql=SELECT TOP 30 a.F_WoNo 工单号, a.F_PartNo 物料编号, a.F_PartName 物料名称, c.F_Specs 规格型号, a.F_OkQty 合格数, a.F_NgQty 不良数, a.F_RequireAmount 需求数, b.F_UnitName 单位, CONVERT(NVARCHAR, CONVERT(DECIMAL(18,2), ROUND((F_OkQty+F_NgQty)*100 / IIF(ISNULL(F_RequireAmount,0)=0, 1, ISNULL(F_RequireAmount,0)), 2))) + '%' 生产进度, CASE WHEN a.F_Status=0 THEN '创建' WHEN a.F_Status=1 THEN '已排程' WHEN a.F_Status=2 THEN '已下发' WHEN a.F_Status=3 THEN '生产中' WHEN a.F_Status=4 THEN '已完成' WHEN a.F_Status=5 THEN '强制结单' ELSE '已取消' END 生产状态 FROM base_workorder a LEFT JOIN base_unit b ON a.F_Unit=b.F_Id LEFT JOIN base_part c ON a.F_partid=c.F_id WHERE a.F_CreatorTime>DATEDIFF(day, GETDATE(), -30) ORDER BY F_RequireTime DESC

[# name=点检未完成项]
[production.inspect_unfinished]
wrap=none
columns=F_EquipName:varchar(100),b:int
sql=SELECT F_EquipName, COUNT(1) b FROM eq_check_record WHERE F_Status=0 GROUP BY F_EquipName
