# 生产进度看板模块

### 1、生产统计分析图表

```sql
sql语句

SELECT CONVERT(DECIMAL(18,0), OkQty)	OkQty ,
       CONVERT(DECIMAL(18, 0), TotalQty)	TotalQty,
       CONVERT(DECIMAL(18, 2), OkQty*100/IIF(TotalQty=0, 1, TotalQty)) AS OkRate,
	   RIGHT(OpDate,5)	OpDate
FROM 
    (SELECT TOP 3 SUM(F_OkQty)	OkQty,
        SUM(F_OkQty+F_NgQty)	TotalQty,
        CONVERT(VARCHAR(100), F_CreatorTime, 111)   OpDate
    FROM mes_report_detail
    WHERE DATEDIFF(DAY,F_CreatorTime,GETDATE())<=14  AND DATEDIFF(day,F_CreatorTime,GETDATE())>= 0 AND (F_OkQty+F_NgQty)>0  
    GROUP BY  CONVERT(VARCHAR(100), F_CreatorTime, 111)  
    ORDER BY  OpDate DESC) a
ORDER BY OpDate

响应数据格式(只展示至多三条数据，多的不显示)

优化后的sql语句
SELECT CONVERT(DECIMAL(18,0), OkQty) AS OkQty,
       CONVERT(DECIMAL(18,0), TotalQty) AS TotalQty,
       CONVERT(DECIMAL(18,2), OkQty*100.0/NULLIF(TotalQty,0)) AS OkRate,
       RIGHT(OpDate,5) AS OpDate
FROM 
    (SELECT TOP 3 
        SUM(F_OkQty) AS OkQty,
        SUM(F_OkQty+F_NgQty) AS TotalQty,
        CONVERT(VARCHAR(100), F_CreatorTime, 111) AS OpDate
    FROM mes_report_detail
    WHERE F_CreatorTime >= DATEADD(DAY, -14, CAST(GETDATE() AS DATE))
      AND F_CreatorTime < DATEADD(DAY, 1, CAST(GETDATE() AS DATE))
      AND (F_OkQty+F_NgQty)>0  
    GROUP BY CONVERT(VARCHAR(100), F_CreatorTime, 111)  
    ORDER BY OpDate DESC) a
ORDER BY OpDate


[
    {
        "OkQty": 18000,
        "TotalQty": 18110,
        "OkRate": 99.39,
        "OpDate": "12/07"
    },
    {
        "OkQty": 36160,
        "TotalQty": 36470,
        "OkRate": 99.15,
        "OpDate": "12/08"
    },
    {
        "OkQty": 16500,
        "TotalQty": 16620,
        "OkRate": 99.28,
        "OpDate": "12/09"
    }
]

```

### 2、原料消耗统计图表

```sql
sql语句

SELECT Convert(decimal(18,0), oknumb)oknumb ,
       Convert(decimal(18, 0), total)total,
       Convert(decimal(18, 2), oknumb*100/total) AS ratess,right( dayss,5)dayss
FROM 
    (SELECT top 6 sum(F_OkQty) oknumb,
        sum(F_OkQty+F_NgQty)total,
        CONVERT(varchar(100), F_CreatorTime, 111)   dayss
    FROM mes_report_detail
    WHERE datediff(day,F_CreatorTime,getdate())<=14  and datediff(day,F_CreatorTime,getdate())>= 0 and (F_OkQty+F_NgQty)>0  
    GROUP BY  CONVERT(varchar(100), F_CreatorTime, 111)  
    ORDER BY  dayss desc) a
ORDER BY  dayss

优化后的sql语句
SELECT CONVERT(DECIMAL(18,0), oknumb) AS oknumb,
       CONVERT(DECIMAL(18,0), total) AS total,
       CONVERT(DECIMAL(18,2), oknumb*100.0/NULLIF(total,0)) AS ratess,
       RIGHT(dayss,5) AS dayss
FROM 
    (SELECT TOP 6 
        SUM(F_OkQty) AS oknumb,
        SUM(F_OkQty+F_NgQty) AS total,
        CONVERT(VARCHAR(100), F_CreatorTime, 111) AS dayss
    FROM mes_report_detail
    WHERE F_CreatorTime >= DATEADD(DAY, -14, CAST(GETDATE() AS DATE))
      AND F_CreatorTime < DATEADD(DAY, 1, CAST(GETDATE() AS DATE))
      AND (F_OkQty+F_NgQty)>0  
    GROUP BY CONVERT(VARCHAR(100), F_CreatorTime, 111)  
    ORDER BY dayss DESC) a
ORDER BY dayss

响应数据格式(只展示至多三条数据，多的不显示)

[
    {
        "oknumb": 24400,
        "total": 24760,
        "ratess": 98.55,
        "dayss": "12/02"
    },
    {
        "oknumb": 22670,
        "total": 22930,
        "ratess": 98.87,
        "dayss": "12/03"
    },
    {
        "oknumb": 47800,
        "total": 48180,
        "ratess": 99.21,
        "dayss": "12/04"
    }
]
```

### 3、本月计划

#### 3.1月合格率

```sql
sql语句

select convert(decimal(18,0),round(sum(F_OkQty)*100.00/IIF(sum(F_OkQty+F_NgQty)=0,1,sum(F_OkQty+F_NgQty)),0) ) value
 from mes_report_detail
where datediff(mm,F_CreatorTime,GETDATE())=0

优化后的sql语句
SELECT CONVERT(DECIMAL(18,0), ROUND(SUM(F_OkQty)*100.0/NULLIF(SUM(F_OkQty+F_NgQty),0),0)) AS value
FROM mes_report_detail
WHERE F_CreatorTime >= DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0)
  AND F_CreatorTime < DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()) + 1, 0)

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": 99
}
```

#### 3.2日合格率

```sql
sql语句

select convert(decimal(18,0),round(ISNULL(sum(F_OkQty),0)*100.00/IIF(ISNULL(sum(F_OkQty+F_NgQty),0)=0,1,sum(F_OkQty+F_NgQty)),2) ) value
from mes_report_detail
where datediff(dd,F_CreatorTime,GETDATE())=0

优化后的sql语句
SELECT CONVERT(DECIMAL(18,0), ROUND(ISNULL(SUM(F_OkQty),0)*100.0/NULLIF(ISNULL(SUM(F_OkQty+F_NgQty),0),0),2)) AS value
FROM mes_report_detail
WHERE F_CreatorTime >= CAST(GETDATE() AS DATE)
  AND F_CreatorTime < DATEADD(DAY, 1, CAST(GETDATE() AS DATE))

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "value": 99
    }
]
```

#### 3.3 未完成值

```sql
sql语句
select convert(decimal(18,0),round(ISNULL(sum(F_RequireAmount-F_OkQty-F_NgQty),0),2) ) curValue
from base_workorder
where datediff(dd,F_CreatorTime,GETDATE())=0

响应数据格式(只展示至多三条数据，多的不显示)
{
    "value": 300818
}
```

#### 3.4完成率

```sql
sql语句
select convert(decimal(18,0),round(ISNULL(sum(F_OkQty+F_NgQty),0)*100.00/IIF(ISNULL(sum(F_RequireAmount),0)=0,1,sum(F_RequireAmount)),2) ) curValue
from base_workorder
where datediff(dd,F_CreatorTime,GETDATE())=0

响应数据格式(只展示至多三条数据，多的不显示)
{
    "value": "2%"
}
```

#### 3.5 完成/计划显示值

```sql
sql语句
select convert(nvarchar(10),convert(decimal(18,0),ISNULL(sum(F_OkQty+F_NgQty),0)))+'/'+convert(nvarchar(20),convert(decimal(18,0),ISNULL(sum(F_RequireAmount),0))) curValue
from base_workorder
where datediff(dd,F_CreatorTime,GETDATE())=0

响应数据格式(只展示至多三条数据，多的不显示)
{
    "value": "6685/307503"
}
```



### 4、生产入库信息统计

```sql
sql语句

SELECT TOP 5 a.F_PartName 产品型号,
SUM(F_Qty) 当月入库数,
(SELECT SUM(F_AvailableQty) FROM wms_inventory WHERE F_PartId=a.F_PartId) 库存数
from wms_warehousein_scandetail a
LEFT JOIN wms_warehousein b on a.F_WarehouseId=b.F_Id
WHERE F_WarehouseType='ProduceIn'
AND datediff(month, a.F_CreatorTime,GETDATE())=0
GROUP BY a.F_PartName,a.F_PartId

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "产品型号": "粘毛器短款外箱大隔板480*200(驱尘氏)1用3",
        "当月入库数": 5207,
        "库存数": 940
    },
    {
        "产品型号": "粘毛器短款外箱大隔板480*200(驱尘氏8套装)1用3(客HF043-1)",
        "当月入库数": 939,
        "库存数": 940
    },
    {
        "产品型号": "(现场)组件-马桶刷桶身白7044+盖子灰7040+边扣白7044",
        "当月入库数": 3608,
        "库存数": null
    },
    {
        "产品型号": "(现场)组件(美)-马桶刷桶身白7044+盖子灰7040+边扣白7044",
        "当月入库数": 600,
        "库存数": null
    },
    {
        "产品型号": "组件-马桶刷上手柄白7044+盖子灰7040",
        "当月入库数": 62778,
        "库存数": 4804
    }
]
}
```

### 5、实时产能监控

```sql
sql语句

select aa.F_FullName value,ISNULL(bb.数量,0) name from base_organize aa
left join (
select b.F_WorkShopId,sum(a.F_OkQty+a.F_NgQty) 数量 from mes_report_detail a
left join base_workorder b on F_WoId=b.F_Id 
where datediff(mm,a.F_creatortime,getdate())=0
group by b.F_WorkShopId)bb on aa.F_Id =bb.F_WorkShopId
where aa.F_Id in (
'1081',
'1082',
'1083'
)

优化后的sql语句
SELECT aa.F_FullName AS value, ISNULL(bb.数量,0) AS name 
FROM base_organize aa
LEFT JOIN (
    SELECT b.F_WorkShopId, SUM(a.F_OkQty+a.F_NgQty) AS 数量 
    FROM mes_report_detail a
    LEFT JOIN base_workorder b ON a.F_WoId=b.F_Id 
    WHERE a.F_CreatorTime >= DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0)
      AND a.F_CreatorTime < DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()) + 1, 0)
    GROUP BY b.F_WorkShopId
) bb ON aa.F_Id = bb.F_WorkShopId
WHERE aa.F_Id IN ('1081', '1082', '1083')

响应数据格式(只展示至多三条数据，多的不显示)
{
    "xList": [
        0,
        0,
        180230
    ],
    "yList": [
        "包装车间",
        "杆盘车间",
        "注塑车间"
    ]
}
```

### 6、生产进度信息

```sql
sql语句
select  top 30 
a.F_WoNo 工单号
,a.F_PartNo 物料编号
,a.F_PartName 物料名称
,c.F_Specs 规格型号
,a.F_OkQty 合格数
,a.F_NgQty 不良数
,a.F_RequireAmount 需求数
,b.F_UnitName 单位
,convert(nvarchar,convert(decimal(18,2),round((F_OkQty+F_NgQty)*100/IIF(ISNULL(F_RequireAmount,0)=0,1,ISNULL(F_RequireAmount,0)),2)))+'%' 生产进度
,case when a.F_Status=0 then '创建' 
when  a.F_Status=1 then '已排程' 
when  a.F_Status=2 then '已下发' 
when  a.F_Status=3 then '生产中' 
when  a.F_Status=4 then '已完成' 
when  a.F_Status=5 then '强制结单' 
else '已取消' end 生产状态
from base_workorder a
left join base_unit b on a.F_Unit=b.F_Id
left join base_part c on a.F_partid=c.F_id
where a.F_CreatorTime>DATEDIFF(day,GETDATE(),-30)
order by F_RequireTime desc

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "工单号": "WO20250728028",
        "物料编号": "02.05.C.1903-01",
        "物料名称": "螺母22#细-黑色3#",
        "规格型号": "20*28",
        "合格数": 0,
        "不良数": 0,
        "需求数": 4840,
        "单位": "个",
        "生产进度": "0.00%",
        "生产状态": "已排程"
    },
    {
        "工单号": "WO20251127015",
        "物料编号": "02.04.B.D10.1511-02",
        "物料名称": "组件-马桶刷上手柄白7044+盖子灰7040",
        "规格型号": "2.3*2.3*20.5+2.5*2.5",
        "合格数": 12500,
        "不良数": 150,
        "需求数": 12000,
        "单位": "个",
        "生产进度": "105.42%",
        "生产状态": "已完成"
    },
    {
        "工单号": "WO20251127010",
        "物料编号": "02.03.B.PM33.1135-03",
        "物料名称": "小号四面挤水-装饰件-蓝色1172(色粉)",
        "规格型号": "98*14*6",
        "合格数": 0,
        "不良数": 0,
        "需求数": 19300,
        "单位": "个",
        "生产进度": "0.00%",
        "生产状态": "已下发"
    }
]
```

### 7、点检未完成项

```sql
sql语句

select F_EquipName 
,count(1) b from
eq_check_record where F_Status=0
group by F_EquipName

响应数据格式(只展示至多三条数据，多的不显示)

[
    {
        "F_EquipName": "21号注塑机(570)",
        "b": 175
    },
    {
        "F_EquipName": "26号注塑机(370)",
        "b": 175
    },
    {
        "F_EquipName": "14号注塑机(540)",
        "b": 170
    },
    {
        "F_EquipName": "34号注塑机(2250)",
        "b": 175
    }
]
```

### 9、各部门当日计划数

```sql
sql语句
select name dayss1,value onoffrate  from (
select top 7 right(convert(nvarchar(10), F_CreatorTime,120),5) name,
sum(case when F_Status=1 then 1 else 0 end)*100.0 /ISNULL(count(1),1) value from eq_check_record
--where datediff(dd,F_CreatorTime,getdate())<7
group by convert(nvarchar(10), F_CreatorTime,120)
order by  convert(nvarchar(10), F_CreatorTime,120) desc
)aa
order by aa.name

响应数据格式(只展示至多三条数据，多的不显示)
[
    {
        "dayss1": "12-06",
        "onoffrate": 0
    },
    {
        "dayss1": "12-07",
        "onoffrate": 0
    },
    {
        "dayss1": "12-08",
        "onoffrate": 0
    },
    {
        "dayss1": "12-09",
        "onoffrate": 0
    },
]
```



#### 9.1计划入库量

```sql
sql语句
select  avg( F_Efficienc) value
from base_equip_runinfo
 where  datediff(day,F_CreateTime,getdate())=0
 
 响应数据格式(只展示至多三条数据，多的不显示)
 {
    "data": "69.50"
}
```



#### 9.2点检完成率

```sql
sql语句
select sum(case when F_Status=1 then 1 else 0 end)*100.0 /ISNULL(count(1),1) value from eq_check_record
where datediff(mm,F_CreatorTime,getdate())=0

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "0.00"
}
```



#### 9.3维修完成率

```sql
sql语句

select ISNULL(sum(case when F_Status=1 then 1 else 0 end)*100.0 /ISNULL(count(1),1),0) value from eq_repair_record
where datediff(mm,F_CreatorTime,getdate())=0

响应数据格式(只展示至多三条数据，多的不显示)
{
    "data": "0.00"
}
```


